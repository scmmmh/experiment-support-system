# -*- coding: utf-8 -*-

try:
    import cPickle as pickle
except:
    import pickle
import os
import sys
import transaction

from pyramid.paster import (get_appsettings, setup_logging)
from sqlalchemy import engine_from_config

from pyquest.models import (DBSession, Base, Survey, QSheet, DataItem,
                            DataItemAttribute, User, Group, Permission,
                            Question, QuestionAttributeGroup, QuestionAttribute,
    QSheetTransition, QSheetInstance)

def usage(argv):
    cmd = os.path.basename(argv[0])
    print('usage: %s <config_uri> [--no-test-data]\n'
          '(example: "%s development.ini")' % (cmd, cmd)) 
    sys.exit(1)

def main(argv=sys.argv):
    if len(argv) < 2:
        usage(argv)
    config_uri = argv[1]
    setup_logging(config_uri)
    settings = get_appsettings(config_uri)
    engine = engine_from_config(settings, 'sqlalchemy.')
    DBSession.configure(bind=engine)
    Base.metadata.create_all(engine)
    init_data(DBSession)
    if len(argv) == 2 or argv[2] != '--no-test-data':
        init_test_data(DBSession)

def init_data(DBSession):
    with transaction.manager:
        user = User(u'mhall', u'm.mhall@sheffield.ac.uk', u'Archchancellor', u'test')
        group = Group(title='Site administrator')
        group.permissions.append(Permission(name='admin.users', title='Administer the users'))
        group.permissions.append(Permission(name='admin.groups', title='Administer the permission groups'))
        user.groups.append(group)
        group = Group(title='Developer')
        group.permissions.append(Permission(name='survey.new', title='Create new surveys'))
        user.groups.append(group)
        DBSession.add(user)
        group = Group(title='Content administrator')
        group.permissions.append(Permission(name='survey.view-all', title='View all surveys'))
        group.permissions.append(Permission(name='survey.edit-all', title='Edit all surveys'))
        group.permissions.append(Permission(name='survey.delete-all', title='Delete all surveys'))
        DBSession.add(group)

def init_test_data(DBSession):
    with transaction.manager:
        user = DBSession.query(User).first()
        survey = Survey(title='A test survey', status='develop', styles='', scripts='')
        # PAGE 1
        qsheet1 = QSheet(name='page1', title='Page 1', styles='', scripts='')
        question = Question(type='text', name='', title='', required=False, help='', order=0)
        qa_group = QuestionAttributeGroup(key='text', label='Free text')
        qa_group.attributes.append(QuestionAttribute(key='text', label='Free text', value='<p>The first page demonstrates the basic question types</p>', order=0))
        question.attributes.append(qa_group)
        qsheet1.questions.append(question)
        question = Question(type='short_text', name='short_text', title='This is a (required) pq:short_text question', required=True, help='Just a bit of help', order=1)
        qsheet1.questions.append(question)
        question = Question(type='long_text', name='long_text', title='A pq:long_text question', required=False, help='', order=2)
        qsheet1.questions.append(question)
        question = Question(type='number', name='number', title='The pq:number question only allows numbers to be input', required=False, help='', order=3)
        qa_group = QuestionAttributeGroup(key='further', label='Further attributes')
        qa_group.attributes.append(QuestionAttribute(key='min', label='Minimum value', value='', order=0))
        qa_group.attributes.append(QuestionAttribute(key='max', label='Maximum value', value='', order=1))
        qa_group.attributes.append(QuestionAttribute(key='step', label='Stepping value', value='', order=2))
        question.attributes.append(qa_group);
        qsheet1.questions.append(question)
        question = Question(type='email', name='email', title='The pq:email question forces a valid e-mail address', required=False, help='', order=4)
        qsheet1.questions.append(question)
        question = Question(type='url', name='url', title='The pq:url question forces a http or https URL', required=False, help='', order=5)
        qsheet1.questions.append(question)
        question = Question(type='date', name='date', title='The pq:date question requires a valid date', required=False, help='', order=6)
        qsheet1.questions.append(question)
        question = Question(type='time', name='time', title='The pq:time question requires a valid time', required=False, help='', order=7)
        qsheet1.questions.append(question)
        question = Question(type='datetime', name='datetime', title='The pq:datetime question requires a valid date and time', required=False, help='', order=8)
        qsheet1.questions.append(question)
        question = Question(type='month', name='month', title='The pq:month question requires a month number between 1 and 12 or at least three letters of the English month name', required=False, help='', order=9)
        qsheet1.questions.append(question)
        survey.qsheets.append(qsheet1)
        # PAGE 2
        qsheet2 = QSheet(name='page2', title='Page 2', styles='', scripts='')
        question = Question(type='text', name='', title='', required=False, help='', order=0)
        qa_group = QuestionAttributeGroup(key='text', label='Free text')
        qa_group.attributes.append(QuestionAttribute(key='text', label='Free text', value='<p>The second page demonstrates the rating elements</p>', order=0))
        question.attributes.append(qa_group)
        qsheet2.questions.append(question)
        question = Question(type='rating', name='rating_1', title='The pq:rating question lets the user select a value from a scale', required=False, help='', order=1)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=0)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='0', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='1', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=1)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='1', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='2', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=2)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='2', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='3', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=3)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='3', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='4', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=4)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='4', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='5', order=1))
        question.attributes.append(qa_group)
        qsheet2.questions.append(question)
        question = Question(type='rating_group', name='rating_2', title='The pq:rating_group creates a grid of questions and answers', required=False, help='', order=2)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=0)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='0', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='1', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=1)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='1', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='2', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=2)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='2', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='3', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=3)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='3', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='4', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=4)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='4', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='5', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='subquestion', label='Sub-question', order=0)
        qa_group.attributes.append(QuestionAttribute(key='name', label='Name', value='q1', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Question 1', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='subquestion', label='Sub-question', order=1)
        qa_group.attributes.append(QuestionAttribute(key='name', label='Name', value='q2', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Question 2', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='subquestion', label='Sub-question', order=2)
        qa_group.attributes.append(QuestionAttribute(key='name', label='Name', value='q3', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Question 3', order=1))
        question.attributes.append(qa_group)
        qsheet2.questions.append(question)
        survey.qsheets.append(qsheet2)
        # PAGE 3
        qsheet3 = QSheet(name='page3', title='Page 3', styles='', scripts='')
        question = Question(type='text', name='', title='', required=False, help='', order=0)
        qa_group = QuestionAttributeGroup(key='text', label='Free text')
        qa_group.attributes.append(QuestionAttribute(key='text', label='Free text', value='<p>The third page demonstrates the single-selection elements</p>', order=0))
        question.attributes.append(qa_group)
        qsheet3.questions.append(question)
        question = Question(type='single_list', name='single_1', title='The pq:rating question lets the user select a value from a scale', required=False, help='', order=1)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=0)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='0', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='1', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=1)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='1', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='2', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=2)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='2', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='3', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=3)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='3', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='4', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=4)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='4', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='5', order=1))
        question.attributes.append(qa_group)
        qsheet3.questions.append(question)
        question = Question(type='single_select', name='single_2', title='The pq:rating question lets the user select a value from a scale', required=False, help='', order=2)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=0)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='0', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='1', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=1)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='1', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='2', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=2)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='2', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='3', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=3)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='3', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='4', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=4)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='4', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='5', order=1))
        question.attributes.append(qa_group)
        qsheet3.questions.append(question)
        question = Question(type='confirm', name='confirm', title='The pq:rating question lets the user select a value from a scale', required=False, help='', order=3)
        qa_group = QuestionAttributeGroup(key='further', label='Answer', order=0)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='true', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Adding a label makes it easier to select the confirmation option', order=1))
        question.attributes.append(qa_group)
        qsheet3.questions.append(question)
        survey.qsheets.append(qsheet3)
        # PAGE 4
        qsheet4 = QSheet(name='page4', title='Page 4', styles='', scripts='')
        question = Question(type='text', name='', title='', required=False, help='', order=0)
        qa_group = QuestionAttributeGroup(key='text', label='Free text')
        qa_group.attributes.append(QuestionAttribute(key='text', label='Free text', value='<p>The fourth page demonstrates the multi-choice elements</p>', order=0))
        question.attributes.append(qa_group)
        qsheet4.questions.append(question)
        question = Question(type='multichoice', name='multi_1', title='The pq:rating question lets the user select a value from a scale', required=False, help='', order=1)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=0)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='0', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='1', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=1)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='1', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='2', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=2)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='2', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='3', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=3)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='3', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='4', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=4)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='4', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='5', order=1))
        question.attributes.append(qa_group)
        qsheet4.questions.append(question)
        question = Question(type='multichoice_group', name='multi_2', title='The pq:rating_group creates a grid of questions and answers', required=False, help='', order=2)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=0)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='0', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='1', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=1)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='1', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='2', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=2)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='2', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='3', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=3)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='3', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='4', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=4)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='4', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='5', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='subquestion', label='Sub-question', order=0)
        qa_group.attributes.append(QuestionAttribute(key='name', label='Name', value='q1', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Question 1', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='subquestion', label='Sub-question', order=1)
        qa_group.attributes.append(QuestionAttribute(key='name', label='Name', value='q2', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Question 2', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='subquestion', label='Sub-question', order=2)
        qa_group.attributes.append(QuestionAttribute(key='name', label='Name', value='q3', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Question 3', order=1))
        question.attributes.append(qa_group)
        qsheet4.questions.append(question)
        survey.qsheets.append(qsheet4)
        # PAGE 5
        qsheet5 = QSheet(name='page5', title='Page 5', styles='', scripts='')
        question = Question(type='text', name='', title='', required=False, help='', order=0)
        qa_group = QuestionAttributeGroup(key='text', label='Free text')
        qa_group.attributes.append(QuestionAttribute(key='text', label='Free text', value='<p>The fifth page demonstrates the ranking element</p>', order=0))
        question.attributes.append(qa_group)
        qsheet5.questions.append(question)
        question = Question(type='ranking', name='ranking_1', title='The pq:rating_group creates a grid of questions and answers', required=True, help='', order=1)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=0)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='dog', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Dog', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=1)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='cat', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Cat', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=2)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='mouse', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Mouse', order=1))
        question.attributes.append(qa_group)
        qa_group = QuestionAttributeGroup(key='answer', label='Answer', order=3)
        qa_group.attributes.append(QuestionAttribute(key='value', label='Value', value='bird', order=0))
        qa_group.attributes.append(QuestionAttribute(key='label', label='Label', value='Bird', order=1))
        question.attributes.append(qa_group)
        qsheet5.questions.append(question)
        survey.qsheets.append(qsheet5)
        qsi1 = QSheetInstance(type='single', qsheet=qsheet1)
        qsi2 = QSheetInstance(type='single', qsheet=qsheet2)
        qsi3 = QSheetInstance(type='single', qsheet=qsheet3)
        qsi4 = QSheetInstance(type='single', qsheet=qsheet4)
        qsi5 = QSheetInstance(type='single', qsheet=qsheet5)
        survey.start = qsi1
        QSheetTransition(source=qsi1, target=qsi2)
        QSheetTransition(source=qsi2, target=qsi3)
        QSheetTransition(source=qsi3, target=qsi4)
        QSheetTransition(source=qsi4, target=qsi5)
        user.surveys.append(survey)
        
        data_item = DataItem(order=1)
        data_item.attributes.append(DataItemAttribute(order=1, key='title', value='This is the first item'))
        data_item.attributes.append(DataItemAttribute(order=2, key='url', value='http://www.example.com/1.html'))
        survey.data_items.append(data_item)
        data_item = DataItem(order=2)
        data_item.attributes.append(DataItemAttribute(order=1, key='title', value='This is the second item'))
        data_item.attributes.append(DataItemAttribute(order=2, key='url', value='http://www.example.com/2.html'))
        survey.data_items.append(data_item)
        data_item = DataItem(order=3, control=True)
        data_item.attributes.append(DataItemAttribute(order=1, key='title', value='This is the third item'))
        data_item.attributes.append(DataItemAttribute(order=2, key='url', value='http://www.example.com/3.html'))
        survey.data_items.append(data_item)
        data_item = DataItem(order=4)
        data_item.attributes.append(DataItemAttribute(order=1, key='title', value='This is the fourth item'))
        data_item.attributes.append(DataItemAttribute(order=2, key='url', value='http://www.example.com/4.html'))
        survey.data_items.append(data_item)
        data_item = DataItem(order=5)
        data_item.attributes.append(DataItemAttribute(order=1, key='title', value='This is the fifth item'))
        data_item.attributes.append(DataItemAttribute(order=2, key='url', value='http://www.example.com/5.html'))
        survey.data_items.append(data_item)
        data_item = DataItem(order=6)
        data_item.attributes.append(DataItemAttribute(order=1, key='title', value='This is the sixth item'))
        data_item.attributes.append(DataItemAttribute(order=2, key='url', value='http://www.example.com/6.html'))
        survey.data_items.append(data_item)
        data_item = DataItem(order=7, control=True)
        data_item.attributes.append(DataItemAttribute(order=1, key='title', value='This is the seventh item'))
        data_item.attributes.append(DataItemAttribute(order=2, key='url', value='http://www.example.com/7.html'))
        survey.data_items.append(data_item)
        data_item = DataItem(order=8)
        data_item.attributes.append(DataItemAttribute(order=1, key='title', value='This is the eighth item'))
        data_item.attributes.append(DataItemAttribute(order=2, key='url', value='http://www.example.com/8.html'))
        survey.data_items.append(data_item)
        data_item = DataItem(order=9)
        data_item.attributes.append(DataItemAttribute(order=1, key='title', value='This is the ninth item'))
        data_item.attributes.append(DataItemAttribute(order=2, key='url', value='http://www.example.com/9.html'))
        survey.data_items.append(data_item)
        data_item = DataItem(order=10)
        data_item.attributes.append(DataItemAttribute(order=1, key='title', value='This is the tenth item'))
        data_item.attributes.append(DataItemAttribute(order=2, key='url', value='http://www.example.com/10.html'))
        survey.data_items.append(data_item)
        DBSession.add(survey)
        