<!DOCTYPE html>
<html xmlns:py="http://genshi.edgewall.org/" xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="../../layout/backend.html"/>
  <head>
    <title>New DataSet</title>
    <script type="text/javascript">
    $(document).ready(function() {

        function removeRow() {
            var link = $(this);
            var tbody = link.closest('table').find('tbody');
            if (tbody.find('tr').length != 1)
               {
                 var row = link.closest('tr')
                 row.fadeOut();
                 setTimeout(function() {row.remove();}, 400);
               }
            return false;
        }

        $('a.action-remove-row').click(removeRow);

        $('a.action-add-row').click(function() {
            var link = $(this);
            var tbody = link.closest('table').find('tbody');
            var row = $('<tr></tr>');
            var input_field = '${h.form.text_field('attribute_key', '', None)}';
            row.append('<td>' + input_field + '</td>');
            var order_field = '${h.form.hidden_field('attribute_order', '3')}';
            row.append('<td>' + order_field + '</td>');
            var remove_link = $('<a href="#" title="Remove this row" class="button action-remove-row"><span class="ui-icon ui-icon-minusthick"></span></a>');
            remove_link.click(removeRow);
            col = $('<td></td>');
            col.append(remove_link);
            row.append(col);
            tbody.append(row);
            tbody.sortable('reload');
            return false;
        });

    });
    </script>
  </head>
  <body>
    ${h.ui.survey_breadcrumbs([(survey.title, {'href': r.route_url('survey.view', sid=survey.id)}),('Data', {'href': r.route_url('data.list', sid=survey.id)}),('New DataSet', {'href':''})], r)}
    ${h.survey.fancy_status(r, survey, class_='survey-status right')}
    ${h.ui.main_menu('data', survey, r)}
    <article>
      <hgroup>
        <h1>New DataSet</h1>
      </hgroup>
      <form action="${r.route_url('data.new', sid=survey.id)}" method="post">
        ${h.form.csrf_token_field(r.session.get_csrf_token())}
        <dl>
          <dt>Name</dt>
          <dd>${h.form.text_field('name', dis.name, e, class_='span-12')}</dd>
	  <dt>Item Attributes</dt>
	  <dd>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
		  <th></th>
		  <th></th>
                </tr>
              </thead>
              <tfoot>
                <tr>
                  <td></td>
                  <td></td>
                  <td><a href="#" title="Add a row" class="button action-add-row" ><span class="ui-icon ui-icon-plusthick"></span></a></td>
                </tr>
              </tfoot>
              <tbody class="role-sortable">
		<py:choose test="len(dis.attribute_keys)">
		  <py:when test="0">
                      <tr>
			<td>${h.form.text_field('attribute_key', '' , e)}</td>
			<td>${h.form.hidden_field('attribute_order', '1')}</td>
			<td><a href="#" title="Remove this row" class="button action-remove-row"><span class="ui-icon ui-icon-minusthick"></span></a></td>
                      </tr>
                      <tr>
			<td>${h.form.text_field('attribute_key', '' , e)}</td>
			<td>${h.form.hidden_field('attribute_order', '2')}</td>
			<td><a href="#" title="Remove this row" class="button action-remove-row"><span class="ui-icon ui-icon-minusthick"></span></a></td>
                      </tr>
		  </py:when>
		  <py:otherwise>
		    <py:for each="idx,ak in enumerate(dis.attribute_keys)">
                      <tr>
			<td>${h.form.text_field('attribute_key', ak.key, e)}</td>
			<td>${h.form.hidden_field('attribute_order', '')}</td>
			<td><a href="#" title="Remove this row" class="button action-remove-row"><span class="ui-icon ui-icon-minusthick"></span></a></td>
                      </tr>
		    </py:for>
		  </py:otherwise>
		</py:choose>
              </tbody>
            </table>

	  </dd>
        </dl>
        <ul class="buttons span-22">
          <li>${h.form.button("Don't create", class_='button', onclick="document.location='%s'" % r.route_url('data.list', sid=survey.id))}</li>
          <li>${h.form.submit('Create', class_='button')}</li>
        </ul>
      </form>
    </article>
  </body>
</html>
