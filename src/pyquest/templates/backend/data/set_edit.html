<!DOCTYPE html>
<html xmlns:py="http://genshi.edgewall.org/" xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="../../layout/backend.html"/>
  <head>
    <title>Edit Data Set</title>
    <script type="text/javascript">
      $(document).ready(function() {
    	  $('#data-filter-form input[type=submit]').hide();
    	  $('#data-filter-form select').change(function(ev, ui) {
    		 $('#data-filter-form').submit(); 
    	  });

        function removeRow() {
            var link = $(this);
            var tbody = link.closest('table').find('tbody');
            if (tbody.find('tr').length != 1)
               {
                 var row = link.closest('tr')
                 row.fadeOut();
                 setTimeout(function() {row.remove();}, 400);
               }
            return false;
        }

        $('a.action-remove-row').click(removeRow);

        $('a.action-add-row').click(function() {
            var link = $(this);
            var tbody = link.closest('table').find('tbody');
            var nrows = tbody.find('tr').length
            var row = $('<tr></tr>');
            var input_field = '${h.form.text_field('attribute_keys-nrows.key', '', None)}';
            input_field = input_field.replace(/nrows/, '' + nrows)
            row.append('<td>' + input_field + '</td>');
            var id_field = '${h.form.hidden_field('attribute_keys-nrows.id', '')}';
            id_field = id_field.replace(/nrows/, '' + nrows)
            id_field = id_field.replace(/new_order/, '' + (nrows + 1))
            row.append('<td>' + id_field + '</td>');
            var remove_link = $('<a href="#" title="Remove this row" class="button action-remove-row"><span class="ui-icon ui-icon-minusthick"></span></a>');
            remove_link.click(removeRow);
            col = $('<td></td>');
            col.append(remove_link);
            row.append(col);
            tbody.append(row);
            tbody.sortable('reload');
            return false;
        });

      });
    </script>
  </head>
  <body>
    ${h.ui.survey_breadcrumbs([(survey.title, {'href': r.route_url('survey.view', sid=survey.id)}),('Data', {'href': r.route_url('data.list', sid=survey.id)}),(dis.name, {'href': r.route_url('data.view', sid=survey.id, dsid=dis.id)}), ('Edit', {'href':''})], r)}
    ${h.survey.fancy_status(r, survey, class_='survey-status right')}
    ${h.ui.main_menu('data', survey, r)}
    <nav class="toolbar">
    </nav>
    <article>
      <hgroup>
        <h1>Edit Data Set</h1>
      </hgroup>
      <form action="${r.route_url('data.edit', sid=dis.survey_id, dsid=dis.id)}" method="post">
        ${h.form.csrf_token_field(r.session.get_csrf_token())}
	<div class="span-24" style="overflow:auto;">
          <dt>Name</dt>
          <dd>${h.form.text_field('name', dis.name, e, class_='span-12')}</dd>
          <dt>Item Attributes</dt>
	  <dd>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th></th>
		  <th></th>
                </tr>
              </thead>
              <tfoot>
                <tr>
                  <td></td>
                  <td></td>
                  <td><a href="#" title="Add a row" class="button action-add-row" ><span class="ui-icon ui-icon-plusthick"></span></a></td>
                </tr>
              </tfoot>
              <tbody class="role-sortable">
		<py:for each="idx, ak in enumerate(dis.attribute_keys)">
                  <tr>
		    <td>${h.form.text_field('attribute_keys-%d.key' % idx, ak.key , e)}</td>
		    <td>${h.form.hidden_field('attribute_keys-%d.id' % idx, ak.id)}</td>
		    <td><a href="#" title="Remove this row" class="button action-remove-row"><span class="ui-icon ui-icon-minusthick"></span></a></td>
                  </tr>
		</py:for>
              </tbody>
            </table>
	  </dd>
          <ul class="buttons span-22">
            <li>${h.form.button("Don't update", class_='button', onclick="document.location='%s'" % r.route_url('data.list', sid=dis.survey_id))}</li>
            <li>${h.form.submit('Update', class_='button')}</li>
          </ul>
<!--          <table>
            <thead>
              <tr py:if="dis.items">
		<th>Control item</th>
		<th py:for="attribute in dis.attribute_keys">${attribute.key}</th>
		<th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr py:if="len(dis.items) == 0">
		<td class="placeholder">This dataset contains no data item. Use the "Add Item" button to
                 add data.</td>
              </tr>
              <tr py:for="item in dis.items">
		<td><py:if test="item.control">Yes</py:if></td>
		<td py:for="attribute in item.sorted_attributes()">${attribute.value}</td>
		<td>
                  <ul class="inline no-symbol no-margin">
                    <li><a href="${r.route_url('data.item.edit', sid=dis.survey_id, dsid=dis.id, did=item.id)}" class="button">Edit</a></li>
                    <li><a href="${r.route_url('data.item.delete', sid=dis.survey_id, dsid=dis.id, did=item.id)}" class="button post-submit" data-confirm="Please confirm that you wish to delete this data item.">Delete</a></li>
                  </ul>
		</td>
              </tr>
            </tbody>
          </table>-->
	</div>
      </form>
    </article>
  </body>
</html>
