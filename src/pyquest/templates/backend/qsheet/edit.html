<!DOCTYPE html>
<html xmlns:py="http://genshi.edgewall.org/" xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="../../layout/backend.html"/>
  <head>
    <title>${survey.title} - ${qsheet.title} - Edit</title>
    <script type="text/javascript">
    function fix_control_positions() {
    	clearTimeout($('#qsheet-content').data('pyquest.timeout'));
    	$('#qsheet-content').data('pyquest.timeout', setTimeout(function() {
            var top = $(window).scrollTop() - $('#qsheet-content').outerHeight() - $('#qsheet-content').position().top + $(window).innerHeight() - $('#main-buttons').outerHeight() - 30;
            $('#main-buttons').stop().animate({top: Math.min(top, 0)});
            top = $(window).scrollTop() - $('#qsheet-content').position().top + 10;
            $('#tools').stop().animate({top: Math.max(top, 0)});
    	}, 100));
    }
    function show_text_editor(text, item) {
    	var editor = $('#editor');
    	var overlay = $('#editor-overlay');
        editor.show();
    	editor-overlay.show();
    	editor-overlay.css('width', $(window).innerWidth() + 'px').css('height', $(window).innerHeight() + 'px');
    	content = editor.find('.role-content');
    	content.html(text.html());
    	content.ckeditor(function() {
    		var ckedit = this;
            editor.position({
                my: 'center center',
                at: 'center center',
                of: $(window)
            });
            editor.find('.role-close').click(function() {
                ckedit.destroy();
                editor.hide();
                overlay.hide();
                $(this).unbind('click');
            });
            editor.find('.role-save').click(function() {
            	text.html(ckedit.getData());
            	item.find('.role-stored-text').html(ckedit.getData());
                ckedit.destroy();
                editor.hide();
                overlay.hide();
                $(this).unbind('click');
                $('#qsheet-form .buttons .action-save').click();
            });
    		this.focus();
    	});
    }
    function init_item(item) {
        var header = item.find('.header .title');
        var link = $('<a href="#"></a>').append(header.html());
        link.click(function() {
            if(link.data('pyquest-status') == 'compressed') {
            	link.data('pyquest-status', 'expanded');
            	link.html(link.html().replace(/\s-\s.*/, ''));
                item.addClass('status-expanded');
                item.removeClass('status-compressed');
                item.find('.content').slideDown();
            } else {
                link.data('pyquest-status', 'compressed');
                var q_name = item.find('.role-question-name');
                if(q_name.length != 0) {
                	link.html(link.html() + ' - ' + q_name.val());
                }
                item.removeClass('status-expanded');
                item.addClass('status-compressed');
                item.find('.content').slideUp();
            }
            setTimeout(fix_control_positions, 500);
            return false;
        });
        header.html(link);
        item.find('.action-delete').click(function() {
            $.ajax($(this).attr('href'), {
                type: 'POST',
                dataType: 'json',
                success: function() {
                    item.fadeOut();
                    setTimeout(function() {
                    	item.remove();
                        if($('#qsheet-content').children().length == 1) {
                            $('#qsheet-content li.placeholder').show();
                        }
                        fix_control_positions();
                    }, 500);
                }
            })
            return false;
        });
        item.find('.action-edit-text').click(function() {
        	show_text_editor(item.find('.role-editable-text'), item);
        	return false;
        });
        item.find('.role-editable-text').dblclick(function() {
        	show_text_editor($(this), item);
        });
        item.find('tbody.role-sortable').sortable({
            update: function(ev, ui) {
                ui.item.parent().find('input.role-row-order').each(function(idx) {
                    $(this).val(idx);
                });
            }
        });
        item.find('a.action-remove-row').click(function() {
            var link = $(this);
            var row = link.parent().parent();
            row.fadeOut();
            setTimeout(function() {row.remove();}, 400);
            fix_control_positions();
            return false;
        });
        item.find('a.action-add-row').click(function() {
            var link = $(this);
            var tbody = link.parent().parent().parent().parent().find('tbody');
            var row_id = 0;
            tbody.find('input[type="text"]').each(function() {
            	row_id = Math.max(row_id, parseInt($(this).attr('name').match(/-[0-9]+/)[0].slice(1)));
            });
            row_id = row_id + 1;
            var row = $('<tr></tr>');
            var input_field = '${h.form.text_field('field_name', '', None)}';
            var part = link.data('pyquest-part');
            var col = null;
            for(var idx in part.columns) {
            	var input_text = input_field.replace('field_name', link.data('pyquest-qid') + '.' + part['name'] + '-' + row_id + '.' + part['columns'][idx]['name']);
            	col = $('<td>' + input_text + '</td>');
            	row.append(col);
            }
            var remove_link = $('<a href="#" title="Remove this row" class="button action-remove-row"><span class="ui-icon ui-icon-minusthick"></span></a>');
            remove_link.click(function() {
                var link = $(this);
                var row = link.parent().parent();
                row.fadeOut();
                setTimeout(function() {row.remove();}, 400);
                fix_control_positions();
                return false;
            });
            col = $('<td></td>');
            col.append('<input type="hidden" name="' + link.data('pyquest-qid') + '.' + part['name'] + '-' + row_id + '.' + '_order" value="' + row_id + '" class="role-row-order"/>');
            col.append(remove_link);
            row.append(col);
            tbody.append(row);
            tbody.sortable('reload');
            fix_control_positions();
            return false;
        });
    }
    function set_transition_buttons(){
        $('.add-transition-condition').click(function() {
            $.ajax('${r.route_url('survey.qsheet.edit.add_condition', sid=survey.id, qsid=qsheet.id)}', {
        			success: function(response) {
            $('dd.transition').html(response);
            set_transition_buttons();
}
});
        return false;
        });
        $('.delete-transition-condition').click(function() {
            $.ajax('${r.route_url('survey.qsheet.edit.delete_condition', sid=survey.id, qsid=qsheet.id)}', {
        			success: function(response) {
            $('dd.transition').html(response);
            set_transition_buttons();
}
});
        return false;
        });
    }


    $(document).ready(function() {
        make_toggle_link('role-css-edit');
        make_toggle_link('role-js-edit');
        $('.role-accordion-2').accordion();
        $('.role-accordion-1').accordion();
        $('.role-accordion-0').accordion();
        $('#qsheet-content').sortable({
        	receive: function(ev, ui) {
        		var q_type = ui.item.data('pyquest-name');
        		var item_order = ui.item.prev('li').find('.role-order').val();
        		if(!item_order) {
        			item_order = 0;
        		} else {
        			item_order = item_order + 1;
        		}
        		ui.item.html('Loading...');
        		ui.item.addClass('item');
        		$.ajax('${r.route_url('survey.qsheet.edit.add_question', sid=survey.id, qsid=qsheet.id)}', {
        			success: function(response) {
                        $('#qsheet-content li.placeholder').hide();
        				ui.item.html($(response).children());
        				init_item(ui.item);
                        $('input.role-order').each(function(idx) {
                            $(this).val(idx);
                        });
                        fix_control_positions();
        			},
        			error: function() {
        				ui.item.remove();
        			},
        			type: 'POST',
        			dataType: 'html',
        			data: {
        				q_type: q_type,
        				order: item_order
        			}
        		});
        	},
        	update: function(ev, ui) {
        		$('input.role-order').each(function(idx) {
        			$(this).val(idx);
        		});
        	},
        	placeholder: 'droppable'
        });
        $('#qsheet-content li.item').each(function() {
        	init_item($(this));
        });
        $('#tools ol li').draggable({
        	helper: 'clone',
        	connectToSortable: '#qsheet-content'
        });
        if($('#qsheet-content').children().length != 1) {
        	$('#qsheet-content li.placeholder').hide();
        }
        var main_form = $('#qsheet-form');
        main_form.find('.buttons .action-save').click(function() {
        	var btn = $(this);
        	clearTimeout(btn.data('pyquest.timeout'));
        	btn.val('Updating...');
        	main_form.find('.error').each(function() {
        		var err = $(this);
        		err.replaceWith(err.find('.input').children());
        	});
        	$.ajax(main_form.attr('action'), {
        		type: 'POST',
        		dataType: 'json',
        		data: main_form.serialize(),
        		success: function(data) {
        			if(data.e) {
        				for(var name in data.e) {
        					$('[name="' + name + '"]').each(function() {
        						var err = $('<div class="error"><div class="input"></div><p class="error-explanation">' + data.e[name] + '</p></div>');
        						var input = $(this);
        						input.replaceWith(err);
        						err.find('.input').append(input);
        					});
        				}
                        btn.val('Not updated').css('background-color', '#aa3333').css('color', '#ffffff');
        			} else {
        				btn.val('Updated').css('background-color', '#33aa33').css('color', '#ffffff');
        			}
        			fix_control_positions();
                    btn.data('pyquest.timeout',
                    		setTimeout(function() {btn.val('Update').css('background-color', '').css('color', '');}, 10000));
        		}
        	});
        	return false;
        });
        $('.action-edit-layout').click(function() {
        	var btn = $(this);
        	btn.parent().addClass('current');
            $('.action-edit-settings').parent().removeClass('current');
            $('.role-edit-layout').show();
            $('.role-edit-settings').hide();
            fix_control_positions();
            return false;
        }).parent().addClass('current');
        $('.action-edit-settings').click(function() {
            var btn = $(this);
            btn.parent().addClass('current');
            $('.action-edit-layout').parent().removeClass('current');
            $('.role-edit-layout').hide();
            $('.role-edit-settings').show();
            fix_control_positions();
            return false;
        });
        $('.role-edit-layout').show();
        $('.role-edit-settings').hide();
        $(window).scroll(function(ev) {
        	fix_control_positions();
        }).resize(function(ev) {
        	fix_control_positions();
        });
        fix_control_positions();
        set_transition_buttons();
    });
    </script>
  </head>
  <body>
    ${h.ui.survey_breadcrumbs([(survey.title, {'href': r.route_url('survey.view', sid=survey.id)}), (qsheet.title, {'href': r.route_url('survey.qsheet.view', sid=survey.id, qsid=qsheet.id)}), ('Edit', {'href': r.route_url('survey.qsheet.edit', sid=survey.id, qsid=qsheet.id)})], r)}
    ${h.survey.fancy_status(r, survey, class_='survey-status right')}
    ${h.ui.main_menu('survey', survey, r)}
    <nav class="toolbar">
      <ul>
        <li><a href="${r.route_url('survey.qsheet.view', sid=survey.id, qsid=qsheet.id)}" class="button">Preview</a></li>
        <li><a href="${r.route_url('survey.qsheet.edit.source', sid=survey.id, qsid=qsheet.id)}" class="button">Edit Source</a></li>
        <li py:if="h.auth.is_authorised(':survey.is-owned-by(:user) or :user.has_permission(\'survey.edit-all\')', {'user': h.user.current_user(r), 'survey': survey})"><a href="${r.route_url('survey.data', sid=survey.id, qsid=qsheet.id)}" class="button">Data</a></li>
      </ul>
    </nav>
    <article>
      <div py:if="survey.status in ['running', 'paused', 'finished'] and len(survey.participants) > 0" class="error">The survey is currently ${h.survey.status(survey.status, True)}
        and any changes you make here will not be reflected in the answers that have already been provided by the participants.</div>
      <hgroup>
        <h1>${qsheet.title} - Edit</h1>
      </hgroup>
      <noscript class="error clearfix">JavaScript is required to use all the functionality provided by this page. If you cannot use
        JavaScript, it is recommended that you use the <a href="${r.route_url('survey.qsheet.edit.source', sid=survey.id, qsid=qsheet.id)}">source-editing page</a> instead.</noscript>
      <form id="qsheet-form" action="${r.route_url('survey.qsheet.edit', sid=survey.id, qsid=qsheet.id)}" method="post">
        <div class="error" py:if="e">${repr(e.error_dict)}</div>
        ${h.form.csrf_token_field(r.session.get_csrf_token())}
        <nav class="sections">
          <ul>
            <li><a href="#" class="action-edit-layout">Layout</a></li>
            <li><a href="#" class="action-edit-settings">Settings</a></li>
          </ul>
        </nav>
        <section class="role-edit-settings">
          <dl>
            <dt>Name</dt>
            <dd>${h.form.text_field('name', qsheet.name, e)}</dd>
            <dt>Title</dt>
            <dd>${h.form.text_field('title', qsheet.title, e)}</dd>
            <dt>Type</dt>
            <dd>${h.form.select('repeat', qsheet.attr_value('repeat', default='single'), [('single', 'Single'), ('repeat', 'Repeated')], e, class_='role-qsheet-repeat')}</dd>
            <dt>Data Items</dt>
            <dd>${h.form.number_field('data_items', qsheet.attr_value('data-items', default='0'), e, class_='role-qsheet-data-items')}</dd>
            <dt>Control Items</dt>
            <dd>${h.form.number_field('control_items', qsheet.attr_value('control-items', default='0'), e, class_='role-qsheet-control-items')}</dd>
            <dt>Show Question Numbers</dt>
            <dd>${h.form.select('show_question_numbers', qsheet.attr_value('show-question-numbers', default='yes'), [('yes', 'Yes'), ('no', 'No')], e, class_='role-qsheet-show-question-numbers')}</dd>
	    <dt>Transition</dt>
	    <py:with vars="source=False">
	    <dd class="transition"><xi:include href="transitions.html"/></dd>
	    </py:with>
            <dt class="role-css-edit-toggle">CSS styles</dt>
            <dd>${h.form.textarea('styles', qsheet.styles, e, class_='span-22 role-css-edit')}</dd>
            <dt class="role-js-edit-toggle">Javascript</dt>
            <dd>${h.form.textarea('scripts', qsheet.scripts, e, class_='span-22 role-js-edit')}</dd>
          </dl>
        </section>
        <section class="role-edit-layout clearfix">
            <aside id="tools" class="right role-accordion-0" style="width:200px;position:relative;">
              ${h.qsheet.question_type_list(question_type_groups)}
              <!-- 
              <py:for each="q_type_group in question_type_groups">
                <h3><a href="#">${q_type_group.title}</a></h3>
                <ol py:if="q_type_group.q_types">
                  <li py:for="q_type in q_type_group.q_types" data-pyquest-name="${q_type.name}">${q_type.title}</li>
                </ol>
              </py:for> -->
            </aside>
            <ol id="qsheet-content" style="width:700px;">
              <li class="placeholder">Drag elements from the right to construct the questionnaire sheet.</li>
              <py:for each="idx, question in enumerate(qsheet.questions)">
                <xi:include href="edit_fragment.html"/>
              </py:for>
            </ol>
        </section>
        <ul id="main-buttons" class="buttons" style="position:relative;z-index:1;background-color:#ffffff;border:1px dotted;width:698px;padding:0 1.5em;">
          <li>${h.form.button("Don't update", class_='button', onclick="document.location='%s'" % r.route_url('survey.qsheet.view', sid=survey.id, qsid=qsheet.id))}</li>
          <li>${h.form.submit('Update', class_='button action-save')}</li>
        </ul>
      </form>
    </article>
    <div id="editor-overlay" class="overlay hidden"></div>
    <div id="editor" class="editor hidden">
      <div class="role-content"></div>
      <ul class="buttons">
         <li><a href="#" class="button role-close">Don't save</a></li>
         <li><a href="#" class="button role-save">Save</a></li>
      </ul>
    </div>
  </body>
</html>
