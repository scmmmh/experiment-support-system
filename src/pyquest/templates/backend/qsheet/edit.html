<!DOCTYPE html>
<html xmlns:py="http://genshi.edgewall.org/" xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="../../layout/backend.html"/>
  <head>
    <title>${survey.title} - ${qsheet.title} - Edit</title>
    <script type="text/javascript">
    function show_text_editor(text, item) {
        text.ckeditor(function() {
            this.on('focus', function() {
                $('#qsheet-content').sortable('disable');
            });
            this.on('blur', function() {
                item.find('.role-stored-text').html(this.getData());
                this.destroy();
                $('#qsheet-content').sortable('enable');
            });
            this.focus();
        });
    }
    function init_item(item) {
        var header = item.find('.header .title');
        var link = $('<a href="#"></a>').append(header.html()).click(function() {
            item.find('.content').slideToggle();
            return false;
        });
        header.html(link);
        item.find('.action-delete').click(function() {
            $.ajax($(this).attr('href'), {
                type: 'POST',
                dataType: 'json',
                success: function() {
                    item.fadeOut();
                    setTimeout(function() {
                    	item.remove();
                        if($('#qsheet-content').children().length == 1) {
                            $('#qsheet-content li.placeholder').show();
                        }
                    }, 500);
                }
            })
            return false;
        });
        item.find('.action-edit-text').click(function() {
        	show_text_editor(item.find('.role-editable-text'), item);
        	return false;
        });
        item.find('.role-editable-text').dblclick(function() {
        	show_text_editor($(this), item);
        });
    }
    $(document).ready(function() {
        make_toggle_link('role-css-edit');
        make_toggle_link('role-js-edit');
        $('#tools').accordion();
        $('#qsheet-content').sortable({
        	receive: function(ev, ui) {
        		var q_type = 'unknown';
        		var dropped_type = ui.item.html();
        		if(dropped_type == 'Static text') {
        			q_type = 'text';
                } else if(dropped_type == 'Single-line text') {
                    q_type = 'short_text';
                } else if(dropped_type == 'Multi-line text') {
                    q_type = 'long_text';
                } else if(dropped_type == 'Number') {
                    q_type = 'number';
                } else if(dropped_type == 'E-Mail') {
                    q_type = 'email';
                } else if(dropped_type == 'URL') {
                    q_type = 'url';
                } else if(dropped_type == 'Date') {
                    q_type = 'date';
                } else if(dropped_type == 'Time') {
                    q_type = 'time';
                } else if(dropped_type == 'Date &amp; Time') {
                    q_type = 'datetime';
                } else if(dropped_type == 'Month') {
                    q_type = 'month';
                } else if(dropped_type == 'Single choice') {
                    q_type = 'single_choice';
                } else if(dropped_type == 'Rating grid') {
                    q_type = 'rating_group';
                } else if(dropped_type == 'Confirmation') {
                    q_type = 'confirm';
                } else if(dropped_type == 'Multiple choice') {
                    q_type = 'multi_choice';
                } else if(dropped_type == 'Multiple choice grid') {
                    q_type = 'multichoice_group';
                } else if(dropped_type == 'Ranking') {
                    q_type = 'ranking';
        		}
        		ui.item.html('Loading...');
        		ui.item.addClass('item');
        		$('#qsheet-content li.placeholder').hide();
        		$.ajax('${r.route_url('survey.qsheet.edit.add_question', sid=survey.id, qsid=qsheet.id)}', {
        			success: function(response) {
        				ui.item.html($(response).children());
        				init_item(ui.item);
                        $('input.role-order').each(function(idx) {
                            $(this).val(idx);
                        });
        			},
        			error: function() {
        				ui.item.remove();
        			},
        			type: 'POST',
        			dataType: 'html',
        			data: {'type': q_type}
        		});
        	},
        	update: function(ev, ui) {
        		$('input.role-order').each(function(idx) {
        			$(this).val(idx);
        		});
        	}
        });
        $('#qsheet-content li').each(function() {
        	init_item($(this));
        });
        $('#tools ol li').draggable({
        	helper: 'clone',
        	connectToSortable: '#qsheet-content'
        });
        $('#qsheet-content a.action-remove-answer').click(function() {
        	var link = $(this);
        	var row = link.parent().parent();
        	row.fadeOut();
        	setTimeout(function() {row.remove();}, 400);
        	return false;
        });
        $('#qsheet-content a.action-add-answer').click(function() {
            var link = $(this);
            var tbody = link.parent().parent().parent().find('table tbody');
            var qid = tbody.parent().parent().parent().parent().parent().find('input.role-id').val();
            var aid = 0;
            var found = true;
            while(found) {
                if(tbody.find('input[name=\'' + qid + '.answer-' + aid + '.order\']').length == 0) {
                    found = false;
                } else {
                    aid = aid + 1;
                }
            }
            var row = $('<tr style="display:none;"></tr>');
            row.append($('<td>${h.form.hidden_field('{qid}.answer-{aid}.order', '{order}', class_='role-answer-order')}${h.form.text_field('{qid}.answer-{aid}.value', '', e)}</td>'.replace(/{qid}/g, qid).replace(/{aid}/g, aid).replace(/{order}/, tbody.children().length)));
            row.append($('<td>${h.form.text_field('{qid}.answer-{aid}.label', '', e)}</td>'.replace(/{qid}/g, qid).replace(/{aid}/g, aid)));
            var remove_link = $('<a href="#" class="button action-remove-answer"><span class="ui-icon ui-icon-minusthick"></span></a>');
            remove_link.click(function() {
                var link = $(this);
                var row = link.parent().parent();
                row.fadeOut();
                setTimeout(function() {row.remove();}, 400);
                return false;
            });
            var cell = $('<td></td>');
            cell.append(remove_link);
            row.append(cell);
            tbody.append(row);
            row.fadeIn();
            tbody.sortable('reload');
            return false;
        });
        $('#qsheet-content tbody.role-answers').sortable({
            update: function(ev, ui) {
                ui.item.parent().find('input.role-answer-order').each(function(idx) {
                    $(this).val(idx);
                });
            }
        });
        $('#qsheet-content a.action-remove-subquestion').click(function() {
            var link = $(this);
            var row = link.parent().parent();
            row.fadeOut();
            setTimeout(function() {row.remove();}, 400);
            return false;
        });
        $('#qsheet-content a.action-add-subquestion').click(function() {
            var link = $(this);
            var tbody = link.parent().parent().parent().find('table tbody');
            var qid = tbody.parent().parent().parent().parent().parent().find('input.role-id').val();
            var sid = 0;
            var found = true;
            while(found) {
                if(tbody.find('input[name=\'' + qid + '.sub_quest-' + sid + '.order\']').length == 0) {
                    found = false;
                } else {
                    sid = sid + 1;
                }
            }
            var row = $('<tr style="display:none;"></tr>');
            row.append($('<td>${h.form.hidden_field('{qid}.sub_quest-{sid}.order', '{order}', class_='role-subquestion-order')}${h.form.text_field('{qid}.sub_quest-{sid}.name', '', e)}</td>'.replace(/{qid}/g, qid).replace(/{sid}/g, sid).replace(/{order}/, tbody.children().length)));
            row.append($('<td>${h.form.text_field('{qid}.sub_quest-{sid}.label', '', e)}</td>'.replace(/{qid}/g, qid).replace(/{sid}/g, sid)));
            var remove_link = $('<a href="#" class="button action-remove-answer"><span class="ui-icon ui-icon-minusthick"></span></a>');
            remove_link.click(function() {
                var link = $(this);
                var row = link.parent().parent();
                row.fadeOut();
                setTimeout(function() {row.remove();}, 400);
                return false;
            });
            var cell = $('<td></td>');
            cell.append(remove_link);
            row.append(cell);
            tbody.append(row);
            row.fadeIn();
            tbody.sortable('reload');
            return false;
        });
        $('#qsheet-content tbody.role-subquestions').sortable({
            update: function(ev, ui) {
                ui.item.parent().find('input.role-subquestion-order').each(function(idx) {
                    $(this).val(idx);
                });
            }
        });
        if($('#qsheet-content').children().length != 1) {
        	$('#qsheet-content li.placeholder').hide();
        }
    });
    </script>
  </head>
  <body>
    ${h.ui.survey_breadcrumbs([(survey.title, {'href': r.route_url('survey.view', sid=survey.id)}), ('Pages', {'href': r.route_url('survey.qsheet', sid=survey.id)}), (qsheet.title, {'href': r.route_url('survey.qsheet.view', sid=survey.id, qsid=qsheet.id)}), ('Edit', {'href': r.route_url('survey.qsheet.edit', sid=survey.id, qsid=qsheet.id)})], r)}
    ${h.survey.fancy_status(r, survey, class_='survey-status right')}
    ${h.ui.main_menu('pages', survey, r)}
    <nav class="toolbar">
      <ul>
        <li><a href="${r.route_url('survey.qsheet.view', sid=survey.id, qsid=qsheet.id)}" class="button">Preview</a></li>
        <li><a href="${r.route_url('survey.qsheet.edit.source', sid=survey.id, qsid=qsheet.id)}" class="button">Edit Source</a></li>
      </ul>
    </nav>
    <article>
      <div py:if="survey.status in ['running', 'paused', 'finished'] and len(survey.participants) > 0" class="error">The survey is currently ${h.survey.status(survey.status, True)}
        and any changes you make here will not be reflected in the answers that have already been provided by the participants.</div>
      <hgroup>
        <h1>${qsheet.title} - Edit</h1>
      </hgroup>
      <noscript class="error clearfix">JavaScript is required to use all the functionality provided by this page. If you cannot use
        JavaScript, it is recommended that you use the <a href="${r.route_url('survey.qsheet.edit.source', sid=survey.id, qsid=qsheet.id)}">source-editing page</a> instead.</noscript>
      <form action="${r.route_url('survey.qsheet.edit', sid=survey.id, qsid=qsheet.id)}" method="post">
        <div class="error" py:if="e">${repr(e.error_dict)}</div>
        ${h.form.csrf_token(r.session.get_csrf_token())}
        <dl>
          <dt>Name</dt>
          <dd>${h.form.text_field('name', qsheet.name, e)}</dd>
          <dt>Title</dt>
          <dd>${h.form.text_field('title', qsheet.title, e)}</dd>
          <dt class="role-css-edit-toggle">CSS styles</dt>
          <dd>${h.form.textarea('styles', qsheet.styles, e, class_='span-22 role-css-edit')}</dd>
          <dt class="role-js-edit-toggle">Javascript</dt>
          <dd>${h.form.textarea('scripts', qsheet.scripts, e, class_='span-22 role-js-edit')}</dd>
          <dt>Content</dt>
          <dd class="clearfix">
            <aside id="tools" class="right" style="width:200px;">
              <h3><a href="#">Text</a></h3>
              <ol>
                <li>Static text</li>
              </ol>
              <h3><a href="#">Text Input</a></h3>
              <ol>
                <li>Single-line text</li>
                <li>Multi-line text</li>
                <li>Number</li>
                <li>E-Mail</li>
                <li>URL</li>
                <li>Date</li>
                <li>Time</li>
                <li>Date &amp; Time</li>
                <li>Month</li>
              </ol>
              <h3><a href="#">Rating</a></h3>
              <ol>
                <li>Rating grid</li>
              </ol>
              <h3><a href="#">Choice</a></h3>
              <ol>
                <li>Single choice</li>
                <li>Multiple choice</li>
              </ol>
              <h3><a href="#">Multiple choice</a></h3>
              <ol>
                <li>Multiple choice grid</li>
              </ol>
              <h3><a href="#">Other</a></h3>
              <ol>
                <li>Confirmation</li>
                <li>Ranking</li>
              </ol>
            </aside>
            <ol id="qsheet-content" style="width:700px;">
              <li class="placeholder">Drag elements from the right to construct the questionnaire sheet.</li>
              <py:for each="idx, question in enumerate(qsheet.questions)">
                <xi:include href="edit_fragment.html"/>
              </py:for>
            </ol>
          </dd>
        </dl>
        <ul class="buttons span-22">
          <li>${h.form.button("Don't update", class_='button', onclick="document.location='%s'" % r.route_url('survey.qsheet.view', sid=survey.id, qsid=qsheet.id))}</li>
          <li>${h.form.submit('Update', class_='button')}</li>
        </ul>
      </form>
    </article>
  </body>
</html>