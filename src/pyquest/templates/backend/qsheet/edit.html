<!DOCTYPE html>
<html xmlns:py="http://genshi.edgewall.org/" xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="../../layout/backend.html"/>
  <head>
    <title>${survey.title} - ${qsheet.title} - Edit</title>
    <script type="text/javascript">
    $(document).ready(function() {
        make_toggle_link('css-edit');
        make_toggle_link('js-edit');
        $('#tools').accordion();
        $('#qsheet-content').sortable({
        	receive: function(ev, ui) {
        		ui.item.html('Loading...');
        		ui.item.addClass('item');
        		$('#qsheet-content li.placeholder').hide();
        		$.get('${r.route_url('survey.qsheet.edit.fragment', sid=survey.id, qsid=qsheet.id)}', function(response) {
        			ui.item.html($(response).children());
        		});
        	},
        	update: function(ev, ui) {
        		$('input.role-order').each(function(idx) {
        			$(this).val(idx);
        		});
        	}
        });
        $('#qsheet-content li').each(function() {
        	var item = $(this);
        	var header = item.find('.header');
        	var link = $('<a href="#"></a>').append(header.html()).click(function() {
        		item.find('.content').slideToggle();
        		return false;
        	});
        	header.html(link);
        });
        $('#tools ol li').draggable({
        	helper: 'clone',
        	connectToSortable: '#qsheet-content'
        });
        if($('#qsheet-content').children().length != 1) {
        	$('#qsheet-content li.placeholder').hide();
        }
    });
    </script>
  </head>
  <body>
    ${h.ui.survey_breadcrumbs([(survey.title, {'href': r.route_url('survey.view', sid=survey.id)}), ('Pages', {'href': r.route_url('survey.qsheet', sid=survey.id)}), (qsheet.title, {'href': r.route_url('survey.qsheet.view', sid=survey.id, qsid=qsheet.id)}), ('Edit', {'href': r.route_url('survey.qsheet.edit', sid=survey.id, qsid=qsheet.id)})], r)}
    ${h.survey.fancy_status(r, survey, class_='survey-status right')}
    ${h.ui.main_menu('pages', survey, r)}
    <nav class="toolbar">
      <ul>
        <li><a href="${r.route_url('survey.qsheet.edit.source', sid=survey.id, qsid=qsheet.id)}" class="button">Edit Source</a></li>
      </ul>
    </nav>
    <article>
      <div py:if="survey.status in ['running', 'paused', 'finished'] and len(survey.participants) > 0" class="error">The survey is currently ${h.survey.status(survey.status, True)}
        and any changes you make here will not be reflected in the answers that have already been provided by the participants.</div>
      <hgroup>
        <h1>${qsheet.title} - Edit</h1>
      </hgroup>
      <form action="${r.route_url('survey.qsheet.edit', sid=survey.id, qsid=qsheet.id)}" method="post">
        ${h.form.csrf_token(r.session.get_csrf_token())}
        <dl>
          <dt>Name</dt>
          <dd>${h.form.text_field('name', qsheet.name, e)}</dd>
          <dt>Title</dt>
          <dd>${h.form.text_field('title', qsheet.title, e)}</dd>
          <dt id="css-edit-toggle">CSS styles</dt>
          <dd>${h.form.textarea('styles', qsheet.styles, e, class_='span-22', id="css-edit")}</dd>
          <dt id="js-edit-toggle">Javascript</dt>
          <dd>${h.form.textarea('scripts', qsheet.scripts, e, class_='span-22', id="js-edit")}</dd>
          <dt>Content</dt>
          <dd class="clearfix">
            <aside id="tools" class="right" style="width:200px;">
              <h3><a href="#">Text</a></h3>
              <ol>
                <li>Static text</li>
              </ol>
              <h3><a href="#">Text Input</a></h3>
              <ol>
                <li>Single-line text</li>
                <li>Multi-line text</li>
                <li>Number</li>
                <li>E-Mail</li>
                <li>URL</li>
                <li>Date</li>
                <li>Time</li>
                <li>Date &amp; Time</li>
                <li>Month</li>
              </ol>
              <h3><a href="#">Rating</a></h3>
              <ol>
                <li>Rating</li>
                <li>Rating grid</li>
              </ol>
              <h3><a href="#">Single choice</a></h3>
              <ol>
                <li>List</li>
                <li>Select</li>
                <li>Confirmation</li>
              </ol>
              <h3><a href="#">Multiple choice</a></h3>
              <ol>
                <li>Multiple choice</li>
                <li>Multiple choice grid</li>
              </ol>
              <h3><a href="#">Ranking</a></h3>
              <ol>
                <li>Ranking</li>
              </ol>
            </aside>
            <ol id="qsheet-content" style="width:700px;">
              <li class="placeholder">Drag elements from the right to construct the questionnaire sheet.</li>
              <li class="item" py:for="question in qsheet.questions">
                ${h.form.hidden_field('id', question.id)}
                <hgroup>
                  <h2 class="header">${h.qsheet.question_type_title(question.type)}</h2>
                </hgroup>
                <div class="content">
                  <py:if test="question.type == 'text'">
                    ${Markup(h.qsheet.get_q_attr(question, 'text.text'))}
                  </py:if>
                  <py:if test="question.type != 'text'">
                    <dl>
                      <dt>Name</dt>
                      <dd>${h.form.text_field('%i.name' % (question.id), question.name, e)}</dd>
                      <dt>Title</dt>
                      <dd>${h.form.text_field('%i.title' % (question.id), question.title, e, class_='span-16')}</dd>
                      <dt>Help</dt>
                      <dd>${h.form.textarea('%i.help' % (question.id), question.help, e, class_='span-16', style='height:50px;')}</dd>
                      <dt>Required</dt>
                      <dd>${h.form.checkbox('%i.required' % (question.id), 'true', e, checked=question.required, label='This question must be answered')}</dd>
                      <py:if test="question.type == 'number'">
                        <dt>Minimum value</dt>
                        <dd>${h.form.number_field('%i.further.min' % (question.id), h.qsheet.get_q_attr(question, 'further.min'), e)}</dd>
                        <dt>Maximum value</dt>
                        <dd>${h.form.number_field('%i.further.max' % (question.id), h.qsheet.get_q_attr(question, 'further.max'), e)}</dd>
                        <dt>Step</dt>
                        <dd>${h.form.number_field('%i.further.step' % (question.id), h.qsheet.get_q_attr(question, 'further.step'), e)}</dd>
                      </py:if>
                      <py:if test="question.type in ['rating', 'rating_group', 'single_list', 'single_select', 'multichoice', 'multichoice_group', 'ranking']">
                        <dt py:if="question.type in ['rating', 'rating_group', 'single_list', 'single_select', 'multichoice', 'multichoice_group']">Answers</dt>
                        <dt py:if="question.type == 'ranking'">Items</dt>
                        <dd>
                          <table>
                            <thead>
                              <tr>
                                <th>Value</th>
                                <th>Label</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr py:for="attr_group in h.qsheet.get_attr_groups(question, 'answer')">
                                <td>${h.form.text_field('%i.answer.%i.value' % (question.id, attr_group.id), h.qsheet.get_qg_attr(attr_group, 'value'), e)}</td>
                                <td>${h.form.text_field('%i.answer.%i.label' % (question.id, attr_group.id), h.qsheet.get_qg_attr(attr_group, 'label'), e)}</td>
                              </tr>
                            </tbody>
                          </table>
                        </dd>
                      </py:if>
                      <py:if test="question.type in ['rating_group', 'multichoice_group']">
                        <dt>Sub-questions</dt>
                        <dd>
                          <table>
                            <thead>
                              <tr>
                                <th>Name</th>
                                <th>Label</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr py:for="attr_group in h.qsheet.get_attr_groups(question, 'subquestion')">
                                <td>${h.form.text_field('%i.sub-quest.%i.name' % (question.id, attr_group.id), h.qsheet.get_qg_attr(attr_group, 'name'), e)}</td>
                                <td>${h.form.text_field('%i.sub-quest.%i.label' % (question.id, attr_group.id), h.qsheet.get_qg_attr(attr_group, 'label'), e)}</td>
                              </tr>
                            </tbody>
                          </table>
                        </dd>
                      </py:if>
                      <py:if test="question.type == 'confirm'">
                        <dt>Value</dt>
                        <dd>${h.form.number_field('%i.further.value' % (question.id), h.qsheet.get_q_attr(question, 'further.value'), e, class_='span-16')}</dd>
                        <dt>Label</dt>
                        <dd>${h.form.number_field('%i.further.label' % (question.id), h.qsheet.get_q_attr(question, 'further.label'), e, class_='span-16')}</dd>
                      </py:if>
                    </dl>
                  </py:if>
                </div>
              </li>
            </ol>
          </dd>
        </dl>
        <ul class="buttons span-22">
          <li>${h.form.button("Don't update", class_='button', onclick="document.location='%s'" % r.route_url('survey.qsheet.view', sid=survey.id, qsid=qsheet.id))}</li>
          <li>${h.form.submit('Update', class_='button')}</li>
        </ul>
      </form>
    </article>
  </body>
</html>