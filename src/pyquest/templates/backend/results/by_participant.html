<!DOCTYPE html>
<html xmlns:py="http://genshi.edgewall.org/" xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="../../layout/backend.html"/>
  <head>
    <title>${survey.title} - Results - Export by Participant</title>
  </head>
  <body>
    ${h.ui.survey_breadcrumbs([(survey.title, {'href': r.route_url('survey.view', sid=survey.id)}), ('Results', {'href': r.route_url('survey.results', sid=survey.id)}), ('Export by Participant', {'href': r.route_url('survey.results.by_participant', sid=survey.id)})], r)}
    ${h.survey.fancy_status(r, survey, class_='survey-status right')}
    ${h.ui.main_menu('results', survey, r)}
    <nav class="toolbar">
      <ul>
        <li>
          <form action="${r.route_url('survey.results.by_participant.ext', sid=survey.id, ext='csv')}" method="post">${h.form.submit('Download as CSV', class_='button')}
            <py:for each="c in selected_columns">${h.form.hidden_field('columns', c)}</py:for><py:for each="idx, (qsn, col) in enumerate(data_identifiers.items())">${h.form.hidden_field('data_identifier-%i.qsheet' % (idx), qsn)}${h.form.hidden_field('data_identifier-%i.column' % (idx), col)}</py:for>
            ${h.form.hidden_field('na_value', na_value)}
            ${h.form.checkbox('spss_safe', spss_safe, e, checked=spss_safe, style="display:none")}
          </form></li>
      </ul>
    </nav>
    <article>
      <hgroup>
        <h1>${survey.title} - Results - Export by Participant</h1>
      </hgroup>
      <form action="${r.route_url('survey.results.by_participant', sid=survey.id)}" method="post">
        <hgroup>
          <h2>Export Settings</h2>
        </hgroup>
        <table>
          <caption>Select which questions to export and, where applicable, what data attribute to use to identify the original data-item.</caption>
          <thead>
            <tr>
              <th>Page</th>
              <th>Columns</th>
              <th>Data Identifier</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-top">Standard columns</td>
              <td>
                <ol>
                  <li>${h.form.checkbox('columns', '_.participant_id', e, checked=('_.participant_id' in selected_columns), label='Participant ID')}</li>
                  <li>${h.form.checkbox('columns', '_.completed', e, checked=('_.completed' in selected_columns), label='Completed Flag')}</li>
                </ol>
              </td>
              <td>
              </td>
            </tr>
            <tr py:for="qsheet in survey.qsheets" py:if="h.results.has_data_questions(qsheet)">
              <td class="text-top">${qsheet.title}</td>
              <td>
                <ol>
                  <li py:for="question in qsheet.questions" py:if="question.q_type.answer_schema()">${h.form.checkbox('columns', '%s.%s' % (qsheet.name, question.name), e, label=question.name, checked=('%s.%s' % (qsheet.name, question.name) in selected_columns))}</li>
                </ol>
              </td>
              <td class="text-top">
                <py:if test="qsheet.data_items">
                  ${h.form.hidden_field('data_identifier-%i.qsheet' % (qsheet.id), qsheet.name)}
                  ${h.form.select('data_identifier-%i.column' % (qsheet.id), data_identifiers[qsheet.name], [('id_', 'Internal Identifier')] + [(attr.key, attr.key) for attr in qsheet.data_items[0].attributes], e)}
                </py:if>
              </td>
            </tr>
          </tbody>
        </table>
        <dl>
          <dt>Non-answered value</dt>
          <dd>${h.form.text_field('na_value', na_value, e)}</dd>
          <dt>SPSS Safe Columns</dt>
          <dd>${h.form.checkbox('spss_safe', spss_safe, e, checked=spss_safe)}</dd>
        </dl>
        <ul class="buttons">
          <li>${h.form.submit('Update Settings', class_='button')}</li>
        </ul>
      </form>
      <div class="span-24" style="overflow:auto;">
        <hgroup>
          <h2>Sample Data</h2>
        </hgroup>
        <table>
          <thead>
            <tr>
              <th py:for="column in columns">${column}</th>
            </tr>
          </thead>
          <tbody>
            <tr py:for="row in rows[0:20]">
              <td py:for="column in columns"><py:if test="column in row">${row[column]}</py:if></td>
            </tr>
          </tbody>
        </table>
      </div>
    </article>
  </body>
</html>
